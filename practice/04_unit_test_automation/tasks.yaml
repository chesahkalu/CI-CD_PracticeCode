apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: echo
spec:
  params:
    - name: message
      description: The message to echo
      type: string
  steps:
    - name: echo-message
      image: alpine:3
      command: [/bin/echo]
      args: ["$(params.message)"]

---
# Define a Task resource in the Tekton CI/CD system
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  # The name of the task is 'cleanup'
  name: cleanup
spec:
  # Description of the task
  description: This task will clean up a workspace by deleting all of the files.
  
  # Define workspaces used by this task
  workspaces:
    - name: source  # Workspace named 'source'

  # Define the steps that make up this task
  steps:
    - name: remove  # Name of the step
      image: alpine:3  # Use the Alpine version 3 Docker image
      env:
        - name: WORKSPACE_SOURCE_PATH  # Define an environment variable
          value: $(workspaces.source.path)  # Value is the path to the 'source' workspace
      workingDir: $(workspaces.source.path)  # Set the working directory to the 'source' workspace path
      securityContext:
        runAsNonRoot: false  # Allows the container to run as root
        runAsUser: 0  # Run as the root user
      script: |
        #!/usr/bin/env sh
        # Enable strict error handling
        set -eu
        echo "Removing all files from ${WORKSPACE_SOURCE_PATH} ..."
        
        # Check if the directory exists
        if [ -d "${WORKSPACE_SOURCE_PATH}" ] ; then
          # Delete non-hidden files and directories
          rm -rf "${WORKSPACE_SOURCE_PATH:?}"/*
          # Delete hidden files and directories excluding the parent directory reference (..)
          rm -rf "${WORKSPACE_SOURCE_PATH}"/.[!.]*
          # Delete hidden files and directories starting with two dots followed by another character
          rm -rf "${WORKSPACE_SOURCE_PATH}"/..?*
        fi
